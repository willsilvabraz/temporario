<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/styles/index.css">
    <title>Cadastro e Lista de Pacientes</title>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <header>
            <h1>Gestão de Pacientes</h1>
        </header>

        <!-- Barra lateral com botões -->
        <div class="sidebar">
            <button id="toggleButtons">Mostrar Botões</button>
            <button id="showForm">Cadastro de Paciente</button>
            <button id="showPacientes">Lista de Pacientes</button>
            <button id="showFila">Fila de Pacientes</button>
        </div>

        <div class="content">
            <!-- Seções que serão exibidas/ocultadas -->
            <div id="formSection" class="section hidden">
                <h2>Cadastro de Paciente</h2>
                <form id="formPaciente">
                    <label for="nome">Nome:</label><br>
                    <input type="text" id="nome" name="nome" required><br><br>

                    <label for="dataNasc">Data de Nascimento:</label><br>
                    <input type="date" id="dataNasc" name="dataNasc" required><br><br>

                    <label for="cpf">CPF:</label><br>
                    <input type="text" id="cpf" name="cpf" required><br><br>

                    <button type="submit">Cadastrar</button>
                </form>
            </div>

            <div id="pacientesSection" class="section hidden">
                <h2>Lista de Pacientes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID (Chave)</th>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Data de Nascimento</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="paciente-lista">
                        <!-- Dados dos pacientes serão inseridos aqui -->
                    </tbody>
                </table>
            </div>

            <div id="filaSection" class="section hidden">
                <h2>Fila de Pacientes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID (Chave)</th>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Data de Nascimento</th>
                            <th>Hora de Chegada</th>
                            <th>Prioridade</th>
                        </tr>
                    </thead>
                    <tbody id="fila-lista">
                        <!-- Dados da fila de pacientes serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal para selecionar prioridade -->
        <div id="priorityModal">
            <div>
                <h3>Escolha a Prioridade</h3>
                <label for="priority">Prioridade:</label>
                <select id="priority">
                    <option value="normal">Normal</option>
                    <option value="preferencial">Preferencial</option>
                    <option value="urgente">Urgente</option>
                </select><br><br>
                <button id="confirmPriority">Confirmar</button>
                <button id="cancelPriority">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const apiURL = 'http://localhost:8080/pacientes';
        const cadastroURL = 'http://localhost:8080/pacientes/cadastro';
        const filacadastroURL = 'http://localhost:8080/fila/cadastro';
        const filaURL = 'http://localhost:8080/fila';

        let pacienteSelecionado = null;

        // Função para listar pacientes e fila de pacientes
        async function listarPacientes() {
            try {
                // Listar pacientes
                const responsePacientes = await fetch(apiURL);
                const dataPacientes = await responsePacientes.json();
                const pacienteLista = document.getElementById('paciente-lista');
                
                pacienteLista.innerHTML = '';

                for (const id in dataPacientes) {
                    const paciente = dataPacientes[id];
                    const row = document.createElement('tr');

                    const idCell = document.createElement('td');
                    idCell.textContent = id;
                    row.appendChild(idCell);

                    const nomeCell = document.createElement('td');
                    nomeCell.textContent = paciente.nome;
                    row.appendChild(nomeCell);

                    const cpfCell = document.createElement('td');
                    cpfCell.textContent = paciente.cpf;
                    row.appendChild(cpfCell);

                    const dataNascCell = document.createElement('td');
                    dataNascCell.textContent = paciente.dataNasc;
                    row.appendChild(dataNascCell);

                    const acaoCell = document.createElement('td');
                    const selectButton = document.createElement('button');
                    selectButton.textContent = 'Selecionar';
                    selectButton.onclick = () => mostrarModal(id, paciente);
                    acaoCell.appendChild(selectButton);
                    row.appendChild(acaoCell);

                    pacienteLista.appendChild(row);
                }

                // Listar fila de pacientes
                const responseFila = await fetch(filaURL);
                const dataFila = await responseFila.json();
                const filaLista = document.getElementById('fila-lista');
                
                filaLista.innerHTML = '';

                for (const id in dataFila) {
                    const pacienteFila = dataFila[id];
                    const row = document.createElement('tr');

                    const idCell = document.createElement('td');
                    idCell.textContent = id;
                    row.appendChild(idCell);

                    const nomeCell = document.createElement('td');
                    nomeCell.textContent = pacienteFila.nome;
                    row.appendChild(nomeCell);

                    const cpfCell = document.createElement('td');
                    cpfCell.textContent = pacienteFila.cpf;
                    row.appendChild(cpfCell);

                    const dataNascCell = document.createElement('td');
                    dataNascCell.textContent = pacienteFila.dataNasc;
                    row.appendChild(dataNascCell);

                    const horaChegadaCell = document.createElement('td');
                    horaChegadaCell.textContent = pacienteFila.horaChegada;
                    row.appendChild(horaChegadaCell);

                    const prioridadeCell = document.createElement('td');
                    prioridadeCell.textContent = pacienteFila.prioridade;
                    row.appendChild(prioridadeCell);

                    filaLista.appendChild(row);
                }
            } catch (error) {
                console.error('Erro ao buscar os dados:', error);
            }
        }

        // Função para mostrar o modal
        function mostrarModal(id, paciente) {
            pacienteSelecionado = { ...paciente, id };
            document.getElementById('priorityModal').style.display = 'flex';
        }

        // Função para fechar o modal
        function fecharModal() {
            document.getElementById('priorityModal').style.display = 'none';
        }

        // Função para enviar dados do paciente com prioridade
        async function enviarDadosPaciente(paciente) {
            if (pacienteSelecionado) {
                const prioridade = document.getElementById('priority').value;
                pacienteSelecionado.prioridade = prioridade;

                try {
                    const response = await fetch(filacadastroURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(pacienteSelecionado),
                    });

                    if (response.ok) {
                        alert('Paciente enviado com sucesso!');
                    } else {
                        alert('Erro ao enviar paciente.');
                    }
                } catch (error) {
                    console.error('Erro ao enviar os dados:', error);
                    alert('Erro ao enviar os dados.');
                }

                fecharModal();
                listarPacientes(); // Atualiza a lista de pacientes e fila após o envio
            }
        }

        // Adiciona eventos aos botões do modal
        document.getElementById('confirmPriority').addEventListener('click', () => enviarDadosPaciente(pacienteSelecionado));
        document.getElementById('cancelPriority').addEventListener('click', fecharModal);

        // Função para cadastrar novo paciente
        const form = document.getElementById('formPaciente');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const paciente = {
                nome: document.getElementById('nome').value,
                dataNasc: document.getElementById('dataNasc').value,
                cpf: document.getElementById('cpf').value,
            };

            try {
                const response = await fetch(cadastroURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paciente),
                });

                if (!response.ok) {
                    throw new Error('Erro ao cadastrar paciente');
                }

                const result = await response.json();
                alert('Paciente cadastrado com sucesso!');
                listarPacientes();  // Atualiza a lista de pacientes após o cadastro
            } catch (error) {
                console.error('Erro ao cadastrar paciente:', error);
                alert('Erro ao cadastrar paciente.');
            }
        });

        // Funções para mostrar/ocultar seções
        document.getElementById('showForm').addEventListener('click', () => {
            document.getElementById('formSection').classList.toggle('hidden');
            document.getElementById('pacientesSection').classList.add('hidden');
            document.getElementById('filaSection').classList.add('hidden');
        });

        document.getElementById('showPacientes').addEventListener('click', () => {
            document.getElementById('pacientesSection').classList.toggle('hidden');
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('filaSection').classList.add('hidden');
            listarPacientes(); // Atualiza a lista de pacientes
        });

        document.getElementById('showFila').addEventListener('click', () => {
            document.getElementById('filaSection').classList.toggle('hidden');
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('pacientesSection').classList.add('hidden');
            listarPacientes(); // Atualiza a lista de pacientes e fila
        });

        // Inicializa a lista de pacientes e fila quando a página carrega
        listarPacientes();
    </script>
</body>
</html>
